(function(g,n,y,O,c,_,v,m,b,w,A){"use strict";const o={DEFAULT_APP_NAME:"Music",DEFAULT_TIME_INTERVAL:5,APPLICATION_ID:"1054951789318909972",LFM_API_KEY:"014ffe8a614370f000d85d95ec30e1be",LFM_DEFAULT_COVER_HASHES:["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"]};A.findByProps("SET_ACTIVITY");const V=A.findByProps("getAssetIds"),x=A.findByStoreName("SelfPresenceStore"),B=A.findByStoreName("UserStore");function p(){return R(null)}function R(e){r.pluginStopped&&(f(!0),e=null),r.lastActivity=e,n.FluxDispatcher.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:e,pid:2312,socketId:"Last.fm@Vendetta"})}async function G(e,t=o.APPLICATION_ID){return e?await V.fetchAssetIds(t,e):[]}let L;const P={};function u(e,t){P[e]=t,L?.()}function $(){return[,L]=m.useReducer(function(e){return~e},0),JSON.stringify(P,null,4)}async function H(){const e=new URLSearchParams({method:"user.getrecenttracks",user:l.username,api_key:o.LFM_API_KEY,format:"json",limit:"1",extended:"1"}).toString(),t=await fetch(`https://ws.audioscrobbler.com/2.0/?${e}`);if(!t.ok)throw new Error(`Failed to fetch the latest scrobble: ${t.statusText}`);const a=await t.json(),i=a?.recenttracks?.track?.[0];if(u("lastAPIResponse",i),!i)throw a;const F=!!i["@attr"]?.nowplaying,C=F?Math.floor(Date.now()/1e3):parseInt(i?.date?.uts);let k=null;try{const h=new URLSearchParams({method:"track.getinfo",artist:i.artist.name,track:i.name,api_key:o.LFM_API_KEY,format:"json"}).toString(),U=await fetch(`https://ws.audioscrobbler.com/2.0/?${h}`);if(U.ok){const Z=await U.json(),M=parseInt(Z?.track?.duration??"0");M>0&&(k=C+Math.floor(M/1e3))}}catch(h){console.warn("Failed to fetch track duration",h)}return{name:i.name,artist:i.artist.name,album:i.album["#text"],albumArt:await j(i.image?.find(function(h){return h.size==="large"})?.["#text"]),url:i.url,date:i.date?.["#text"]??"now",nowPlaying:F,loved:i.loved==="1",from:C,to:k}}async function j(e){return o.LFM_DEFAULT_COVER_HASHES.some(function(t){return e.includes(t)})?null:e}var Y=function(e){return e[e.PLAYING=0]="PLAYING",e[e.STREAMING=1]="STREAMING",e[e.LISTENING=2]="LISTENING",e[e.WATCHING=3]="WATCHING",e[e.COMPETING=5]="COMPETING",e}(Y||{});const s=function(...e){return l.verboseLogging&&console.log(...e)};async function N(){if(r.pluginStopped){s("--> Plugin is unloaded, aborting update()..."),f();return}if(s("--> Fetching last track..."),!l.username)throw v.showToast("Last.fm username is not set!",c.getAssetIDByName("Small")),f(),new Error("Username is not set");if(l.ignoreSpotify)if(x.findActivity(function(a){return a.sync_id})){s("--> Spotify is currently playing, aborting..."),u("isSpotifyIgnored",!0),p();return}else u("isSpotifyIgnored",!1);else u("isSpotifyIgnored",void 0);const e=await H().catch(async function(a){throw s("--> An error occurred while fetching the last track, aborting..."),p(),a});if(u("lastTrack",e),!e.nowPlaying){s("--> Last track is not currently playing, aborting..."),p();return}if(s("--> Track fetched!"),r.lastTrackUrl===e.url){s("--> Last track is the same as the previous one, aborting...");return}const t={name:l.appName||o.DEFAULT_APP_NAME,flags:0,type:l.listeningTo?2:0,details:e.name,state:`by ${e.artist}`,application_id:o.APPLICATION_ID};if(r.lastTrackUrl=e.url,t.name.includes("{{"))for(const a in e)t.name=t.name.replace(`{{${a}}}`,e[a]);if(l.showTimestamp&&typeof e.from=="number"&&(t.timestamps={start:e.from*1e3,...typeof e.to=="number"&&{end:e.to*1e3}}),e.album){const a=await G([e.albumArt]);t.assets={large_image:a[0],large_text:`on ${e.album}`}}s("--> Setting activity..."),u("lastActivity",t),s(t);try{R(t)}catch(a){throw s("--> An error occurred while setting the activity"),p(),a}s("--> Successfully set activity!")}function f(e=!1){r.lastActivity=null,r.lastTrackUrl=null,r.updateInterval&&clearInterval(r.updateInterval),!e&&p()}async function I(){if(r.pluginStopped)throw new Error("Plugin is already stopped!");f();let e=0;await N().catch(function(t){console.error(t),e++}),r.updateInterval=setInterval(function(){return N().then(function(){e=0}).catch(function(t){console.error(t),++e>3&&(console.error("Failed to fetch/set activity 3 times, aborting..."),f())})},(Number(l.timeInterval)||o.DEFAULT_TIME_INTERVAL)*1e3)}const r={};w.plugin.storage.ignoreSpotify??=!0;const l={...w.plugin.storage};var z={settings:m.lazy(function(){return Promise.resolve().then(function(){return J})}),onLoad(){if(r.pluginStopped=!1,B.getCurrentUser())I().catch(console.error);else{const e=function(){I().catch(console.error),n.FluxDispatcher.unsubscribe(e)};n.FluxDispatcher.subscribe("CONNECTION_OPEN",e)}},onUnload(){r.pluginStopped=!0,f()}};const{FormRow:D,FormInput:T,FormDivider:d,FormSwitchRow:S,FormText:K,FormIcon:E}=_.Forms;function q(){async function e(){for(const t in y.storage)y.storage[t]!=null&&(l[t]=y.storage[t]);await I(),v.showToast("Settings updated!",c.getAssetIDByName("Check"))}return n.React.createElement(b.TouchableOpacity,{onPress:e},n.React.createElement(K,{style:{marginRight:12}},"UPDATE"))}var W=n.React.memo(function(){const e=O.useProxy(y.storage),t=n.NavigationNative.useNavigation();return m.useEffect(function(){t.setOptions({title:"Last.fm Configuration",headerRight:q})},[]),n.React.createElement(b.ScrollView,null,n.React.createElement(T,{value:e.appName||void 0,onChangeText:function(a){return e.appName=a.trim()},title:"Discord Application Name",placeholder:o.DEFAULT_APP_NAME,returnKeyType:"done"}),n.React.createElement(d,null),n.React.createElement(T,{required:!0,value:e.username||void 0,onChangeText:function(a){return e.username=a.trim()},title:"Last.fm username",helpText:!e.username&&n.React.createElement(b.Text,{style:{color:"#FF0000"}},"This field is required!"),placeholder:"wumpus123",returnKeyType:"done"}),n.React.createElement(d,null),n.React.createElement(T,{value:e.timeInterval,onChangeText:function(a){return e.timeInterval=a},title:"Update interval (in seconds)",placeholder:o.DEFAULT_TIME_INTERVAL.toString(),keyboardType:"numeric",returnKeyType:"done"}),n.React.createElement(d,null),n.React.createElement(S,{label:"Show time elapsed",subLabel:"Show the time elapsed since the song started playing",leading:n.React.createElement(E,{source:c.getAssetIDByName("clock")}),value:e.showTimestamp,onValueChange:function(a){return e.showTimestamp=a}}),n.React.createElement(d,null),n.React.createElement(S,{label:"Set status as listening",subLabel:'Set your status as "Listening to" instead of "Playing"',leading:n.React.createElement(E,{source:c.getAssetIDByName("ic_headset_neutral")}),value:e.listeningTo,onValueChange:function(a){return e.listeningTo=a}}),n.React.createElement(d,null),n.React.createElement(S,{label:"Hide when Spotify is running",subLabel:"Hide the status when a Spotify activity is detected",leading:n.React.createElement(E,{source:c.getAssetIDByName("img_account_sync_spotify_light_and_dark")}),value:e.ignoreSpotify,onValueChange:function(a){return e.ignoreSpotify=a}}),n.React.createElement(d,null),n.React.createElement(D,{label:"Debug",subLabel:"View debug information",leading:n.React.createElement(E,{source:c.getAssetIDByName("debug")}),trailing:D.Arrow,onPress:function(){t.push("VendettaCustomPage",{title:"Debug",render:m.lazy(function(){return Promise.resolve().then(function(){return X})})})}}))}),J=Object.freeze({__proto__:null,default:W});function Q(){const e=$();return React.createElement(b.ScrollView,null,React.createElement(_.Codeblock,{selectable:!0,style:{margin:12}},e))}var X=Object.freeze({__proto__:null,default:Q});return g.currentSettings=l,g.default=z,g.pluginState=r,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.metro.common,vendetta.plugin,vendetta.storage,vendetta.ui.assets,vendetta.ui.components,vendetta.ui.toasts,window.React,vendetta.metro.common.ReactNative,vendetta,vendetta.metro);
